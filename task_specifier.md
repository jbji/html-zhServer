# 多线程网页服务器

包括
- C-S架构的套接字程序
- 多线程程序
- 熟悉HTTP协议

能够并行同时处理多个服务请求，能够处理静态、动态的网页。

## 静态和动态的网页

静态网页，直接返回返回网页HTML、JS和CSS内容。动态网页，使用CGI、AJAX等语言书写，对于不同的用户返回不同的网页内容。

## CGI

CGI（Common Gateway Interface）提供了使用任何语言构建网页的接口，可以将网页用户的请求传递给应用程序并将产生的数据发回给用户。例如用户在网页上填写表单后，填写的信息需要独立的应用程序进行处理（区别于网页服务器的程序）。

包含CGI文件扩展的文件成为CGI脚本文件。通常由C/C++或者Perl编写，可以在特定的场景下作为可执行文件执行。通常保存在网页服务器的cgi-bin文件夹下。

## 编写CGI程序

其他「常规」的编程和CGI编程之间有着两个主要的差别：
1. CGI程序的输出需要以MIME-类型的header开头。这是一种HTTP header，用来告诉用户（client）接受的内容，通常情况下为
   ```html
   Content-type: text/html
   ```
2. 输出格式需要是HTML或者某种浏览器可以展示的格式。但是有时也可能是非文本格式，例如图片、gif等。

此外CGI程序的编写和常规程序类似。

## Web服务器结构

web服务器的结构大致如下：
1. 在8888端口上创建服务套接字
2. 如下循环
   1. 接收下一个连接：若已经是最大连接数，则存在时间最长的线程终止，关闭其套接字并退出工作线程。如果同时连接数量超过了最大连接数`maxConnextions`，服务器关闭最老的连接并关闭工作线程。关闭线程的工作包括清除共享状态（shared state）并结束套接字。服务器还需要支持其他关闭连接的方式，例如用户主动关闭的情况下服务器工作线程需要检查连接状态并执行相应的操作。
   2. 创建新的线程来处理新的用户连接。
   
当主服务器线程遇到异常的时候则直接退出。

## 要求

### HTTP

支持HTTP 1.0：对网页的不同部分发送不同的HTTP请求。

能够处理GET、POST和HEAD客户请求。

返回正确的状态码，如404、200等，以及正确的文本消息。

```html
<html><body>Not Found. 404</body></html>
```

### 端口和地址

能够**同时并行**处理多个服务请求，即必须多线程。且注意监听端口不是常规的80，可以配置监听的端口。

### 最大连接数和线程池

服务器拥有最大连接数，如果超出则关闭存在时间最长的连接。

实现过程中，由一个主线程创建线程池，通过命令行参数指定线程池的容量。

线程池中的每一个线程都被阻塞，直到有一个http请求到来。当请求的数量大于线程池的数量的时候，将请求缓存起来直到有空闲的线程。

> 求大佬详细解释一下线程池。

### CGI

如前文所说。

### Log文件

提供log机制。

每一行代表一次请求（hit），例如如果HTML包含了两张图片，那么就会产生三次请求。每一行应该包含如下的信息：
1. 发出请求的IP地址（visitor）
2. 发出请求的用户的身份（浏览器版本，电脑版本，UA）
3. visitor的登陆ID
4. hit的时间
5. 请求的方法（GET、POST等）
6. 请求的文件的地址（URL）
7. http状态代码
8. 请求的文件大小
9. 包含了用户正在访问的链接的网页文件（例如用户在某个网页上点击了某个链接，那么日志中应该包含这个网页）

### 文件组织

web服务器根目录：`/webroot`
CGI程序：`/webroot/cgi-bin`
log文件：`/webroot/log`
静态网页：`/webroot/`
默认网页：`/webroot/index.html`
404页面：`/webroot/404.html`

### 测试

#### GET方法

1. 默认页面：`URL: http://hostname or IP address:port`
2. 特定页面：`URL: http://hostname or IP address:port/page1.html`

#### POST方法

3. CGI程序或者动态网页
   1. 计算器：在网页表格中输入两个数，提交到特定的CGI程序，计算两者之和然后返回。`Form Action URL: http://hostname or IP address:port/cgi-bin/calculator.pl (assuming it is in PERL)`
   2. 数据查询：表格中输入xueshengIP，提交至CGI程序，程序与MySQL交互获取学生名字和课程，返回。

### 性能分析

使用Load/Stress工具进行分析，例如http_load、webbench等。观察不同线程池大小下（1~20）的程序性能。